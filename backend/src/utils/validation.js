/**
 * Input validation and sanitization utilities
 */

/**
 * Sanitize string input - remove dangerous characters
 * @param {string} input - Raw input string
 * @returns {string} Sanitized string
 */
function sanitizeString(input) {
    if (typeof input !== 'string') return '';

    return input
        .trim()
        .replace(/<[^>]*>/g, '')           // Remove HTML tags
        .replace(/[<>\"\'`;]/g, '')        // Remove dangerous chars
        .substring(0, 500);                 // Limit length
}

/**
 * Validate donor name
 * @param {string} name - Donor name
 * @returns {object} { valid: boolean, error?: string, value?: string }
 */
function validateDonorName(name) {
    const sanitized = sanitizeString(name);

    if (!sanitized || sanitized.length < 2) {
        return { valid: false, error: 'اسم المتبرع يجب أن يكون حرفين على الأقل' };
    }

    if (sanitized.length > 50) {
        return { valid: false, error: 'اسم المتبرع طويل جدًا (الحد الأقصى 50 حرف)' };
    }

    return { valid: true, value: sanitized };
}

/**
 * Validate donation amount
 * @param {number|string} amount - Donation amount
 * @returns {object} { valid: boolean, error?: string, value?: number }
 */
function validateAmount(amount) {
    const numAmount = parseFloat(amount);

    if (isNaN(numAmount)) {
        return { valid: false, error: 'قيمة التبرع غير صالحة' };
    }

    if (numAmount < 1) {
        return { valid: false, error: 'الحد الأدنى للتبرع 1 دينار' };
    }

    if (numAmount > 10000) {
        return { valid: false, error: 'الحد الأقصى للتبرع 10,000 دينار' };
    }

    // Round to 2 decimal places
    const rounded = Math.round(numAmount * 100) / 100;

    return { valid: true, value: rounded };
}

/**
 * Advanced Profanity Filter with Normalization and Libyan Dialect support
 * @param {string} message - Donation message
 * @returns {object} { valid: boolean, value: string }
 */
function validateMessage(message) {
    if (!message) {
        return { valid: true, value: '' };
    }

    const sanitized = sanitizeString(message);

    // 1. القائمة الشاملة للشتائم (العامة، الليبية، وبمختلف الصيغ)
    const profanityList = [
        'كلب', 'حمار', 'تفه', 'شتم', 'لعن', 'وسخ', 'عاهر', 'منيوك', 'قواد', 'عرص',
        'شرموط', 'لبوة', 'خنيث', 'زبي', 'كس', 'طيز', 'كسمك', 'نيك', 'تناك', 'مص', 'لحس',
        'خرا', 'زق', 'يا حيوان', 'سكس', 'اباحي', 'زب', 'نحبك', 'عاهة', 'عاهات', 'شرموطة', 'اكلة',

        'فرخ', 'تيس', 'صايع', 'مفرخ', 'فرخة', 'طير', 'شلاكة',
        'منيك', 'نيكة', 'عطيب', 'كوال', 'يا خامر', 'خامر', 'يا فاشل',
        'تافه', 'مسخ', 'موسخ', 'يا صايع', 'يا بو ', 'يا ام ', 'يا عيل', 'عيل', 'سربوت', 'صرمك', 'زكمك', 'زكمتك', 'قحبة', 'قحبتك', 'زبر', 'زبري', 'ميبون', 'ميبونه', 'زامل', 'ولد قحبة', 'طيز', 'طيزك', 'اكلة', 'عاضة', 'فقير', 'بوفتة', 'شحات', 'عندين', 'عنديرك', 'عندينريك', 'تشده', 'fuck', 'bitch', 'بوف',
        // عامة (Common Arabic)
        'كلب', 'حيوان', 'حمار', 'تفه', 'تفو', 'وسخ', 'مسخ', 'عاهر', 'عرص', 'قواد', 'شرموط', 'لبوة', 'خنيث', 'واطي', 'حقير', 'سافل', 'زفت', 'زق', 'خرا', 'سكس', 'اباحي', 'نذل', 'تيس', 'شحات', 'بوفتة',
        'فرخ', 'فرخة', 'مفرخ', 'خامر', 'يا خامر', 'عطيب', 'كوال', 'ميبون', 'ميبونه', 'زامل', 'صايع', 'تافه', 'شلاكة', 'سربوت', 'صرمك', 'زكرك', 'زكمك', 'زكمتك', 'قحبة', 'ولد قحبة', 'بنت قحبة', 'عاضة', 'اكلة', 'عندين', 'عنديرك', 'عندينريك', 'فاشل', 'منيك', 'نيكة', 'منيوك', 'منيوكة', 'تشده', 'بوف', 'بوفوز', 'خرة', 'خراي', 'موسخ', 'ياموسخ', 'يا فرخ', 'يا صايع', 'يا تافه', 'زبري', 'زبر', 'كس', 'كسمك', 'كسك', 'طيز', 'طيزك', 'طيري', 'مص', 'لحس', 'نيك', 'تناك', 'تناكة', 'تنيك', 'منيكه', 'قحيب', 'قحبتك', 'زنا', 'زاني', 'لواط', 'خول', 'شاذ', 'قذر', 'شتم', 'لعن', 'زبي', 'نحبك', 'عاهة', 'عاهات', 'شرموطة',
        'يا خامرة', 'يا مسخة', 'يا واطي', 'يا حمارة', 'حيوانة', 'كلبة', 'وسخة', 'عطيبة', 'يا عطب', 'يا فاسد', 'يا واطية', 'يا هامل', 'هامل', 'هامك', 'هاملة', 'يا تيسة', 'حيوانين', 'كوالين', 'منيوكين', 'قحاب', 'شراميط', 'اولاد حرام', 'بنت حرام', 'يا لئيم', 'يا زامل', 'يا ميبون', 'يا صرموك', 'يا منيكة', 'يا تافهة', 'يا صايعة', 'يا فاشلة', 'يا موسخة', 'يا عطيبة', 'يا هاملة', 'كسمك',
        'كسمكم', 'كسمك يا', 'كسم امك', 'كسم بوك', 'كسم اهلك', 'يلعن', 'يلعن بوك', 'يلعن امك', 'يلعن شكلك', 'يلعن والديك', 'يلعن سلفاك', 'يلعن جدك', 'يلعن عرضك', 'يلعن شرفك', 'يلعن اصلك', 'يلعن يومك', 'يلعن دينك', 'تفوه', 'تفووو', 'fuck', 'bitch', 'pussy', 'dick', 'ass', 'shit', 'bastard', 'gay', 'faggot', 'sex', 'porn', 'nude', 'مشتهي', 'شهوة', 'مصة', 'لحسة', 'زبي', 'طيزي', 'كسي', 'صرمي', 'صرم', 'زبرك', 'صرمكم', 'زبركم', 'ممحون', 'ممحونة', 'نيكني', 'تنيكني', 'لحسلي', 'مصلي', 'زب كبير', 'كس ضيق', 'كس كبير', 'طيز كبيرة', 'قحبة كبيرة', 'شرموطة كبيرة', 'عاهر كبيرة', 'فاجرة', 'داشر', 'داشرة', 'خرة عليكم', 'خرا فيكم', 'تفو عليكم', 'وسخين', 'اولاد قحبة', 'اولاد شرموطة', 'قوادة', 'ديوث', 'ديوثة', 'خوال', 'منيوك اصلي', 'منيوك درجة اولى', 'زامل رسمي', 'ميبون رسمي',
        'يا ساقط', 'ساقط', 'ساقطة', 'يا صاقط', 'صاقط', 'يا عايب', 'عايب', 'عايبة', 'يا بلا شرف', 'يا عديم شرف', 'يا منزوع شرف', 'يا تيس بن تيس', 'يا ولد الكلب', 'يا بنت الكلب', 'يا ولد الحمار', 'يا بنت الحمار', 'يا ابن ستين كلب', 'يا ابن ستين صرم', 'يا ابن ستين قحبة', 'يا ابن ستين منيوكة', 'يا عرص كبير', 'يا قواد كبير', 'يا ديوث كبير', 'يا مخنث', 'يا متحرش', 'يا مغتصب', 'يا سارق', 'يا حرامي', 'يا نصاب', 'يا كذاب', 'يا منافق', 'يا وضيع', 'يا حثالة', 'يا قاع', 'يا زبالة', 'يا جيفة', 'مصنن', 'صرمك', 'عاهة', 'تنيكه', 'شلال', 'بارد', 'بليد', 'خرية', 'مبردك', 'مبرد', 'يافقير', 'يا نتن', 'يا ريحة', 'يا خامر اللحية', 'يا خامرة الصرم', 'يا وسخ العين', 'يا بو ذبان', 'يا شحات الويفي', 'يا شحات الرصيد', 'يا بو مفتاح', 'يا بو صنّة', 'يا بو ريحة', 'صنّة', 'نتانة', 'خنزير', 'خنزيرة', 'بغل', 'بغلة', 'تيس الجبل', 'يا بو قرون', 'يا قرني', 'يا مقرن', 'مقرن', 'يا بو لسان', 'يا بو لسان طويل', 'يا نمّام', 'يا فتّان', 'يا حقود', 'يا حسود', 'يا بو عين حارة', 'يا عيّان', 'يا بو نفس', 'يا بو غل', 'يا بو حقد', 'يا بو سواد', 'سواد الوجه', 'يا مسود الوجه', 'يا وجه العتب', 'يا وجه النحس', 'يا منحوس', 'يا فقر', 'يا بوم', 'يا غراب', 'يا وجه البومة', 'يا وجه الغراب', 'يا وجه الشوكة', 'يا وجه اللوح', 'يا لوح', 'يا حجرة', 'يا صخرة', 'يا قاسي', 'يا ظالم', 'يا فاجر', 'يا كافر', 'يا مرتد', 'يا زنديق', 'يا ملحد', 'يا صهيوني', 'يا خاين', 'يا عميل', 'يا رخيص', 'يا بيّاع', 'يا بيّاع عرضه', 'بيّاع شرفه', 'يا تاجر اعراض', 'يا سمسار قحاب', 'يا سمسار عروض',
        'يا معوق', 'يا مشوه', 'يا أحول', 'يا أعمى', 'يا أطرش', 'يا أبكم', 'يا أهبل', 'يا هبيلة', 'يا مريض', 'يا ناقص', 'يا عاهة', 'يا عاهة مستديمة', 'يا متخلف', 'يا منغولي', 'يا غبي', 'يا بهيم', 'يا ثور', 'يا جحش', 'يا صخل', 'يا عنزة', 'يا ذبانة', 'يا برغوث', 'يا قملة', 'يا صيبان', 'يا صيبانة', 'يا جرذ', 'يا فار', 'يا حشرة', 'يا صرصور', 'يا خنفس', 'يا بوعبري', 'عطك ما يرفعك', 'عطك كسرة', 'عطك لبة', 'عطك دعوة', 'عطك ضربة', 'عطك غمة', 'عطك هم', 'عطك غم', 'عطك علة', 'عطك حبة', 'عطك رشة', 'عطك تفتيتة', 'عطك جلطة', 'عطك شلل', 'يا دراه كبد', 'يا دراه', 'دراه', 'يا ماسخ', 'يا صامت', 'يا ثقيل دم', 'يا مليغ', 'يا تافه', 'يا قرقوز', 'يا بهلوان', 'يا أراجوز', 'يا كومبارس', 'يا ذيل', 'يا تابع', 'يا لحاس', 'يا قفاف', 'يا هزّاك', 'يا بندير', 'يا بوق', 'يا طبّال', 'يا زمّار', 'يا رقاص', 'يا هزاز كتاف', 'يا هزاز وسط', 'بايع دينه', 'بايع وطنه', 'بايع ناسه',
        'يا صعلوك', 'يا هلفوت', 'يا كنيس', 'يا زوفري', 'يا زوفري أصلي', 'يا بلطجي', 'يا شبيحة', 'يا مرتزق', 'يا لحسي', 'يا ذنب', 'يا قتيل', 'يا ميت الكلب', 'يا ميت القلب', 'يا بارد', 'يا مثقف', 'يا شطّاح', 'يا طيّر', 'يا منفوخ', 'يا فارغ', 'يا بوقاعة', 'يا طبل', 'يا عيّاية', 'يا بو العريف', 'يا فيلسوف', 'يا كليشة', 'يا طفس', 'يا طفس العين', 'يا لجّة', 'يا لجي', 'يا قندوز', 'يا برنوس', 'يا حمار الحصاد', 'يا ثور الساقية', 'يا بهيم السيرك', 'يا وجه النعل', 'يا قاع حذاء', 'يا صرماية', 'يا صرماية قديمة', 'يا كلب العساكر', 'يا مخبر', 'يا جاسوس', 'يا واشي', 'يا سوسة', 'يا عقرب', 'يا حية', 'يا أفعى', 'يا مسموم', 'يا مغلول', 'يا غلاّل', 'يا حقّاد', 'يا حسّاد', 'يا بو عيون طايرة', 'يا بو عين مالحة', 'يا مشفط', 'يا مشفشف', 'يا مشعشب', 'يا شعشوب', 'يا معفن اللبان', 'يا مروح الفم', 'يا بو طرشة', 'يا بو صنة', 'يا صنة العبط', 'يا ريحة العرق', 'يا بو صنان', 'يا بو صنان قاطع', 'يا نجس النجاسة', 'يا قذر القذارة', 'يا ملعون الوالدين', 'يا ملعون الجد', 'يا ملعون السلف', 'يا سارق الكحل من العين', 'يا سارق الحرام', 'يا جيعان', 'يا جيعان نفس', 'يا شحات الوجاهة', 'يا بو عقد', 'يا معقد', 'يا عقدة', 'يا عقدة نفسية', 'يا مريض نفسي', 'يا مخبل', 'يا ملسوع', 'يا مهبّل', 'يا بو لبّة', 'يا شلافطي', 'يا شليفاك',
        'حثاث', 'جيف', 'زمر', 'شلاح', 'طيار', 'يا منيك المناتيك', 'يا قواد القوادين', 'يا عرص العرصة', 'يا شرموط الشراميط', 'يا ابن الحرام المطلق', 'يا ابن الكلب المسعور', 'يا ولد الشوارع', 'يا ربيب الزناديق', 'يا وجه الصفيح', 'يا وجه القباحة', 'يا قبّاح', 'يا صفق', 'يا صفيق', 'يا قليل حيا', 'يا عديم ذمة', 'يا وسخ الثياب', 'يا عفن الروح', 'يا ميت الضمير', 'يا عبد المال', 'يا شحات اللايكات', 'يا شحات المشاهدات', 'يا طماع', 'يا جشع', 'يا هلوع', 'يا جزوع', 'يا كذوب', 'يا فاشل بكل المقاييس', 'يا أكبر فاشل', 'يا منتهي', 'يا منتهي الصلاحية', 'يا خرابات', 'يا سكراب', 'يا خردة', 'يا وجه القرد', 'يا وجه النسناس', 'يا وجه الضب', 'يا وجه السحلية', 'يا تمساح', 'يا نمرود', 'يا طاغية', 'يا جبار', 'يا مختال', 'يا فخور', 'يا متغطرس', 'يا متفرعن', 'يا فرعون زمانه', 'يا دكتاتور', 'يا ظالم نفسه', 'يا مهلك الروح', 'يا بطل كرتوني', 'يا وهمي', 'يا خيالي', 'يا كذبة', 'يا خدعة', 'يا مسرحية', 'يا تمثيلية', 'يا تافه الدرجة الأولى', 'يا سفيه', 'يا عديم عقل', 'يا ناقص فهم', 'يا دجاجة', 'يا ارنب', 'يا فأر تجارب', 'يا دمية', 'يا ماريونيت', 'يا مسيّر', 'يا منبطح', 'يا زاحف', 'يا خبيث النفس', 'يا لئيم الطبع', 'يا سواد القلب', 'يا حمال الأسية', 'يا صبّار', 'يا بو ركبة', 'يا بو كرشة', 'يا بو عيون', 'يا بو صلعة', 'يا قرعة', 'يا مصلّع', 'يا محفّف', 'يا مزيّن', 'يا شطّاح الأعراس', 'يا طبال الحفلات', 'يا قفاص', 'يا نمام الزناقي', 'يا سوسة الدار', 'يا مقطوع من شجرة', 'يا mجهول النسب', 'يا لقيط', 'يا لقيطة',
        // English
        'fuck', 'fucking', 'fucker', 'motherfucker', 'bitch', 'bitches', 'pussy', 'penis', 'dick', 'cock', 'vagina', 'asshole', 'ass', 'shit', 'shitting', 'shitty', 'bastard', 'gay', 'faggot', 'sex', 'porn', 'nude', 'slut', 'whore', 'cunt', 'twat', 'wanker', 'prick', 'jerk', 'bollocks', 'scum', 'nigga', 'nigger', 'kike', 'spic', 'chink', 'dyke', 'fag', 'homo', 'retard', 'spastic', 'douche', 'douchebag', 'clit', 'clitoris', 'anal', 'orgasm', 'ejaculate', 'cum', 'horny', 'erotic', 'xxx', 'blowjob', 'handjob', 'rimjob', 'gangbang', 'deepthroat', 'milf'
    ];

    // 2. فحص الأنماط المتكررة والروابط (Spam Patterns)
    const spamPatterns = [
        /(.)\1{10,}/,             // تكرار حرف أكثر من 10 مرات
        /(https?:\/\/)/i,         // روابط
        /\b(discord|telegram|kick|twitch)\b/i // روابط خارجية
    ];

    for (const pattern of spamPatterns) {
        if (pattern.test(sanitized)) {
            return { valid: true, value: '[رسالة محظورة]' };
        }
    }

    // 3. خوارزمية كشف الخداع (Text Normalization)
    // أ) إزالة "يا" إذا كانت في بداية الجملة أو قبل كلمة مشبوهة
    const cleanMessage = sanitized
        .replace(/^يا\s+/g, '')       // "يا كلب" في البداية -> "كلب"
        .replace(/\s+يا\s+/g, ' ');   // "انت يا كلب" -> "انت كلب"

    // ب) تنظيف النص من (المسافات، النقاط، الزخارف، الحركات)
    const normalizedText = cleanMessage
        .replace(/[\s\.\-\_\,\;\:\!\?\*\/\\\#\$\%\^\&\(\)\[\]\{\}\+\=]/g, '')
        .replace(/[ًٌٍَُِّْٰ]/g, '')
        .replace(/(.)\1+/g, '$1');

    const lowerOriginal = sanitized.toLowerCase();
    const lowerClean = cleanMessage.toLowerCase();
    const lowerNormalized = normalizedText.toLowerCase();

    // 4. الفحص المزدوج (Original, Cleaned & Normalized)
    // نستخدم Set للكلمات الكاملة لزيادة السرعة
    const profanitySet = new Set(profanityList.map(w => w.toLowerCase()));

    // أ) فحص الكلمات الفردية في النص الأصلي والمُنظف
    const originalWords = lowerOriginal.split(/\s+/);
    const cleanWords = lowerClean.split(/\s+/);

    for (const word of [...originalWords, ...cleanWords]) {
        if (profanitySet.has(word)) {
            return { valid: true, value: '[رسالة محظورة]' };
        }
    }

    // ب) فحص الكلمات كمقاطع (Substrings) لـ (كسمك، قحبتكم...)
    for (const word of profanityList) {
        if (word.length > 2) {
            if (lowerOriginal.includes(word) || lowerNormalized.includes(word)) {
                return { valid: true, value: '[رسالة محظورة]' };
            }
        }
    }

    return { valid: true, value: sanitized.substring(0, 200) };
}

/**
 * Validate complete donation input
 * @param {object} data - { donor_name, amount, message }
 * @returns {object} { valid: boolean, errors?: array, data?: object }
 */
function validateDonation(data) {
    const errors = [];
    const validated = {};

    // Validate donor name
    const nameResult = validateDonorName(data.donor_name);
    if (!nameResult.valid) {
        errors.push(nameResult.error);
    } else {
        validated.donor_name = nameResult.value;
    }

    // Validate amount
    const amountResult = validateAmount(data.amount);
    if (!amountResult.valid) {
        errors.push(amountResult.error);
    } else {
        validated.amount = amountResult.value;
    }

    // Validate message
    const messageResult = validateMessage(data.message);
    validated.message = messageResult.value;

    if (errors.length > 0) {
        return { valid: false, errors };
    }

    return { valid: true, data: validated };
}

module.exports = {
    sanitizeString,
    validateDonorName,
    validateAmount,
    validateMessage,
    validateDonation
};
